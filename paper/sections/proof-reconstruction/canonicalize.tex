\documentclass[../../main.tex]{subfiles}
\begin{document}


\subsubsection{Canonicalize. (REVISANDO)}
\label{sssec:canonicalize}

One of the main purposes of the \canonicalize rule consists of adding the
axioms to the problem. In this process, some transformations are carried
out by convert a \verb!fof! formula to their clausal normal form.
The process mainly consists of removing redundancies (tautologies or
definitions) that we know as converting the proposition to its normalized
form, that is the reason why we define the following type definition.
The motivation for this definitions was mainly guided by a
reading of the \Metis source code.

\begin{definition}
  \NProp is the type for a formula in normalized negative normal form
  in which negations appear only in the literals and the formula only uses
  ($⊥$, $⊤$, $¬$, $∧$, $∨$) logical constants.
  We define the \NProp type in a similar way as we did for \Prop type.
\end{definition}

\begin{notation}
A sequent $Γ ⟝ φ$ represents a theorem where
$Γ$ is a set of \Prop propositions premises, and $φ : \NProp$ is the
conclusion of the theorem.
\end{notation}

\begin{myremark}
The $⟝$ theorems have the same subset of rules
for the connectives of \NProp type in Fig.~\ref{fig:CPL-inference-rules}.
We can refer in the latter to some functions defined on previous sections
for \Prop type but in this section they may act for \NProp proposition.
In that case, we do not mention but we redefine the function in order
to work with \NProp propositions.
\end{myremark}

% -------------------------------------------------------------------

To reconstruct \canonicalize we need to perform some transformations
that involve translating the formula to its normalized form and
converting the formula to its negative normal form or conjunctive normal form.

At the first stage, we remove redundancies of the formula. We say that
there are redundancies in a formula when some of the following theorems can apply inside the formula.

  \[
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ ⊥$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ ⊤$}
      \UnaryInfC{$Γ ⟝ ⊤$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ ¬ φ$}
      \UnaryInfC{$Γ ⟝ ⊤$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ φ$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
  \]

  \[
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ ⊥$}
      \UnaryInfC{$Γ ⟝ ⊥$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ ⊤$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ ¬ φ$}
      \UnaryInfC{$Γ ⟝ ⊥$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ φ$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
  \]

% \begin{myremark}
% Here and below, we assume all formulas to be in right-associative form in
% the input of the functions. To perform such conversion, we can apply
% the $\rm{rdisj}$ and $\rm{rconj}$ functions depending on the main connective
% in~(\ref{eq:rdisj}).
% \end{myremark}

\begin{notation}
In a disjunction, $φ₁ ∨ φ₂ ∨ \cdots ∨ φₙ$, we say $ψ ∈_{∨} φ$,
if there is some $i = 1, \cdots, n$ such that $ψ ≡ φᵢ$.
Note that $ψ ∈_{∨} φ$ is another name for the equality
$ψ ≡ \fconjunct_{∨}~φ~ψ$.
\end{notation}

The following lemma serves to remove repeated disjuncts in disjunctions.
We make sure that the formula is to be right-associative to apply it.

\begin{myexample}
\begin{equation}
\label{eq:lemma-rm-or-example}
  \begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ (ψ ∨ (φ ∨ φ)) ∨ φ $}
  \RightLabel{Lemma~\ref{lem:rassoc}}
  \UnaryInfC{$Γ ⟝ \fassoc_{∨}~(φ ∨ (ψ ∨ (φ ∨ φ)) ∨ φ) $}
  \RightLabel{by (\ref{eq:fassoc}).}
  \UnaryInfC{$Γ ⟝ φ ∨ (ψ ∨ (φ ∨ (φ ∨ φ)))$}
  \RightLabel{Lemma~\ref{lem:rm-or}}
  \UnaryInfC{$Γ ⟝ ψ ∨ φ$}
  \end{bprooftree}
  \end{equation}
\end{myexample}

\begin{mainlemma}
  \label{lem:rm-or}
  If $Γ ⟝ φ$ then $Γ ⟝ \frm_{∨}~φ$, where,
  \begin{align*}
  \label{def:rm-or}
    \begin{split}
      &\frm_{∨} :  \NProp \to \NProp\\
      &\frm_{∨}~φ =
      \begin{cases}
        \frm_{∨}~φ₂,    &\text{ if }φ ≡ φ₁ ∨ φ₂\text{ and }φ₁ ∈_{∨} φ₂\\
        φ₁~∨~rm_{∨}~φ₂, &\text{ if }φ ≡ φ₁ ∨ φ₂\\
        φ,  &\text{ otherwise.}
      \end{cases}
    \end{split}
  \end{align*}
\end{mainlemma}

Now, we can remove the following kind of redundancies
using the Lemma.~\ref{lem:canon-or}.

\begin{equation*}
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ ¬~φ$}
  \UnaryInfC{$Γ ⟝ ⊤$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ ⊤$}
  \UnaryInfC{$Γ ⟝ ⊤$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ ⊥$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ φ$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}
\end{equation*}

\begin{mainlemma}
  \label{lem:canon-or}
  If $Γ ⟝ φ$ then $Γ ⟝ \fcanon_{∨}~φ$, where,

\begin{equation*}
\label{eq:canon-or}
\begin{aligned}
 &\hspace{.495mm}\fcanon_{∨} : \NProp \to \NProp\\
 &\begin{array}{llll}
   \fcanon_{∨} &(φ ∨ ⊥)  &= φ \\
   \fcanon_{∨} &(⊥ ∨ φ)  &= φ \\
   \fcanon_{∨} &(⊤ ∨ φ)  &= ⊤  \\
   \fcanon_{∨} &(φ ∨ ⊤)  &= ⊤  \\
   \fcanon_{∨} &(φ₁ ∨ φ₂) &= \frm_∨~(\rm{ndisj}_∨~(φ₁ ∨ φ₂)) \\
   \fcanon_{∨} &φ         &= φ.
  \end{array}\\[2mm]
  \text{and }\\[2mm]
  &\hspace{.495mm}\rm{ndisj}_{∨} : \NProp \to \NProp\\
  &\begin{array}{lll}
    \rm{ndisj}_{∨} &(¬ φ₁ ∨ φ₂) &=
        \begin{cases}
         ⊤, &\text{ if } φ₁ ∈_{∨} φ₂\\
         ⊤, &\text{ if } \rm{ndisj}_{∨}~φ₂≡ ⊤\\
         ¬ φ₁ ∨ \rm{ndisj}_{∨}~φ₂, &\text{ otherwise.}
        \end{cases}\\

  \rm{ndisj}_{∨} &(φ₁ ∨ φ₂)&=
        \begin{cases}
         ⊤, &\,\,\,\,\,\,\text{ if } ¬φ₁ ∈_{∨} φ₂ \\
         ⊤, &\,\,\,\,\,\,\text{ if } \rm{ndisj}_{∨}(φ₂) ≡ ⊤\\
         φ₁ ∨ \rm{ndisj}_{∨}~φ₂, &\,\,\,\,\,\,\text{ otherwise.}
        \end{cases}\\
    \rm{ndisj}_{∨}&φ &=φ.
    \end{array}
\end{aligned}
\end{equation*}
\end{mainlemma}

Now, we have removed redundancies in the disjunctions by applying
$\fcanon_{∨}$ function, in a similar way, we define the $\fcanon_{∧}$ function to work with conjunctions.

\begin{notation}
In a conjunction, $φ = φ₁ ∧ φ₂ ∧ \cdots ∧ φₙ$, we say
$ψ ∈_{∧} φ$, if there is some $i = 1, \cdots, n$ such that $ψ ≡ φᵢ$.
We define $ψ ∈_{∧} φ$ as the equality $ψ ≡ \fconjunct~φ~ψ$.
\end{notation}

\begin{mainlemma}
  \label{lem:rm-and}
  If $Γ ⟝ φ$ then $Γ ⟝ \frm_{∧}~φ$, where,

  \begin{align*}
    \begin{split}
    &\frm_{∧} : \NProp \to \NProp\\
    &\frm_{∧}~φ =
    \begin{cases}
      rm_{∧}~φ₂,      &\text{ if }φ ≡ φ₁ ∧ φ₂\text{ and }φ₁ ∈_{∧} φ₂\\
      φ₁ ∧ rm_{∧}~φ₂, &\text{ if }φ ≡ φ₁ ∧ φ₂\\
      φ,               &\text{ otherwise.}
    \end{cases}
    \end{split}
  \end{align*}
\end{mainlemma}

In conjunctions we remove the following redundancies
using Lemma~\ref{lem:canon-and}.

\begin{equation*}
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ ¬~φ$}
  \UnaryInfC{$Γ ⟝ ⊥$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ ⊤$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ ⊥$}
  \UnaryInfC{$Γ ⟝ ⊥$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ φ$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}
\end{equation*}

\begin{mainlemma}
  \label{lem:canon-and}
  If $Γ ⟝ φ$ then $Γ ⟝ \fcanon_{∧}~φ$, where,
  \begin{equation*}
   \label{eq:canon-and}
    \begin{aligned}
     &\hspace{.495mm}\fcanon_{∧} : \NProp \to \NProp\\
      &\begin{array}{lll}
        \fcanon_{∧} &(⊤ ∧ φ₂)  &= φ₂ \\
        \fcanon_{∧} &(φ₁ ∧ ⊤)  &= φ₁ \\
        \fcanon_{∧} &(⊥ ∧ φ₂)  &= ⊥  \\
        \fcanon_{∧} &(φ₁ ∧ ⊥)  &= ⊥  \\
        \fcanon_{∧} &(φ₁ ∧ φ₂) &= \frm_∧(\rm{ndisj}_∧(φ₁ ∧ φ₂)) \\
        \fcanon_{∧} &φ         &= φ
       \end{array}\\
  \text{and }\\
    &\hspace{.495mm}\rm{ndisj}_{∧} : \NProp \to \NProp\\
    &\begin{array}{lll}
      \rm{ndisj}_{∧}&(¬ φ₁ ∧ φ₂) &=
        \begin{cases}
          ⊥, &\text{ if } φ₁ ∈_{∧} φ₂\\
          ⊥, &\text{ if } \rm{ndisj}_{∧}(φ₂) ≡ ⊥\\
          ¬ φ₁ ∧ \rm{ndisj}_{∧}(φ₂), &\text{ otherwise.}
        \end{cases}\\
      \rm{ndisj}_{∧}&(φ₁ ∧ φ₂) &=
        \begin{cases}
          ⊥,  &\,\,\,\,\,\,\text{ if } φ₁ ∈_{∧} φ₂\\
          ⊥,  &\,\,\,\,\,\,\text{ if } \rm{ndisj}_{∧}(φ₂) ≡ ⊥\\
          φ₁ ∧ \rm{ndisj}_{∧}(φ₂), &\,\,\,\,\,\,\text{ otherwise.}
        \end{cases}\\
      \rm{ndisj}_{∧} &φ &=φ.
     \end{array}
    \end{aligned}
  \end{equation*}
\end{mainlemma}

Now, we can translate formulas from \Prop to \NProp by defining $\fnnfp$,
the negative normal form function. Its definition is based on the
\Metis source code to normalize formulas.
To define such a function we follow the same idea to
the $\fnnf$ function described in \citeauthor{Bezem2002}~\cite{Bezem2002}.
Their $\fnnf$ function translates formulas to their negative normal form.
In the reference, the authors avoid a termination problem with a similar
function by using the polarity of the formula as an additional argument of
the function.

\begin{equation}
\label{eq:nnf-zero}
  \begin{aligned}
  &\hspace{.495mm}\fnnfp : \abbre{Polarity} \to \Prop \to \NProp\\
    &\begin{array}{lll}
      \fnnfp~⊕~(φ₁ ∧ φ₂) &=\fcanon_{∧}~(\fnnfp~⊕~φ₁ ∧ \fnnfp~⊕~φ₂)\\
      \fnnfp~⊕~(φ₁ ∨ φ₂) &=\fcanon_{∨}~(\fnnfp~⊕~φ₁ ∨ \fnnfp~⊕~φ₂)\\
      \fnnfp~⊕~(φ₁ ⇒ φ₂) &=\fcanon_{∨}~(\fnnfp~⊖~φ₁ ∨ \fnnfp~⊕~φ₂)\\
      \fnnfp~⊕~(¬ φ₁)    &=\fnnfp~⊖~φ₁                              \\
      \fnnfp~⊕~φ         &=φ        \\
      \fnnfp~⊖~(φ₁ ∧ φ₂) &=\fcanon_{∨}(\fnnfp~⊖~φ₁ ∨ \fnnfp~⊖~φ₂)\\
      \fnnfp~⊖~(φ₁ ∨ φ₂) &=\fcanon_{∧}(\fnnfp~⊖~φ₁ ∧ \fnnfp~⊖~φ₂)\\
      \fnnfp~⊖~(φ₁ ⇒ φ₂) &=\fcanon_{∧}(\fnnfp~⊖~φ₂ ∧ \fnnfp~⊖~φ₁)\\
      \fnnfp~⊖~(¬ φ₁)    &=\fnnfp~⊕~φ₁\\
      \fnnfp~⊖~⊤         &=⊥\\
      \fnnfp~⊖~⊥         &=⊤\\
      \fnnfp~⊖~φ         &=φ
    \end{array}
  \end{aligned}
\end{equation}

We define the \abbre{Polarity} type with
two constructors: $⊕$ to denote positive polarity, and $⊖$ to denote
negative polarity of a formula.

\begin{myremark}
The formula polarity was not
relevant in the following description since we found using the $⊕$ polarity to
call \fpolarity function for the first time was enough to get
the normalized normal form for propositions.
\end{myremark}

\begin{mainlemma}
  \label{lem:lem-nnf}
  If $Γ ⊢ φ$ then $Γ ⟝ \fnnf~φ$ where,
  \begin{align*}
   \begin{split}
     &\fnnf : \NProp \to \NProp\\
     &\fnnf~φ = \fnnfp~⊕~φ.
   \end{split}
  \end{align*}
\end{mainlemma}

Now, to convert a formula to its conjunctive normal form, in Lemma~\ref{lem:lem-dist} we apply the appropriate distribution functions to the normalized negative formula given by $\fnnf$ function.

\begin{mainlemma}
  \label{lem:lem-dist}
  $Γ ⟝ φ$ then $Γ ⟝ \fdist~φ$, where,
  \begin{equation*}
  \begin{aligned}
  &\hspace{.495mm}\fdist : \NProp \to \NProp\\
  &\begin{array}{lll}
    \fdist &(φ₁ ∧ φ₂) &= \fdist~φ₁ ∧ \fdist~φ₂\\
    \fdist &(φ₁ ∨ φ₂) &= \fdist_{∨}~(\fdist~φ₁ ∨ \fdist~φ₂)\\
    \fdist &φ         &= φ
   \end{array}\\
  \text{and}\\
  &\hspace{.495mm}\fdist_{∨} : \NProp \to \NProp\\
  &\begin{array}{lll}
    \fdist_{∨}&((φ₁ ∧ φ₂) ∨ φ₃) &= \fdist_{∨}(φ₁ ∨ φ₂) ∧ \fdist_{∨}(φ₂ ∨ φ₃)\\
    \fdist_{∨}&(φ₁ ∨ (φ₂ ∧ φ₃)) &= \fdist_{∨}(φ₁ ∨ φ₂) ∧ \fdist_{∨}(φ₁ ∨ φ₃)\\
    \fdist_{∨}&φ &= φ.
    \end{array}
   \end{aligned}
  \end{equation*}
\end{mainlemma}

\begin{proof} If $φ ≡ φ₁ ∨ φ₂$, we get for $i = 1, 2$,
\begin{equation*}
  \begin{bprooftree}
    \RightLabel{assume}
    \AxiomC{$Γ, φ_{i} ⊢ φ_{i}$}
    \RightLabel{by hyp.}
    \UnaryInfC{$Γ ⊢ \fdist~φ_{i}$}
    \RightLabel{∨-intro$_{1,2}$}
    \UnaryInfC{$Γ, φ_{i} ⊢ \fdist~φ₁ ∨ \fdist~φ₂$}
    \RightLabel{Lemma~\ref{lem:dist-or}}
    \UnaryInfC{$Γ, φ_{i} ⊢ \fdist_{∨}(\fdist~φ₁ ∨ \fdist~φ₂)$}
    \end{bprooftree}
\end{equation*}

Then, by using the ∨-elim rule in the last derivation above, we
derive $Γ, φ₁ ∨ φ₂ ⟝ \fdist_{∨}(\fdist~φ₁ ∨ \fdist~φ₂)$ and the lemma
follows.
\end{proof}

We complete the translation between \Prop and \NProp types by
defining the $\fform$ function in (\ref{eq:form}) to get a proposition from
its normalized proposition.

\begin{equation}
\label{eq:form}
  \begin{aligned}
  &\hspace{.495mm}\fform : \NProp \to \Prop\\
  &\begin{array}{llll}
    \fform &(φ₁ ∧ φ₂) &= \fform~φ₁ ∧ \fform~φ₂ &\\
    \fform &(φ₁ ∨ φ₂) &= \fform~φ₁ ∨ \fform~φ₂ &\\
    \fform &φ         &= φ
   \end{array}
  \end{aligned}
  \end{equation}

\begin{mainlemma}
  \label{lem:lem-form}
   If $Γ ⟝ φ$ then $Γ ⊢ \fform~φ$.
\end{mainlemma}

As a result, we can get a conjunctive normal form by applying the
following theorem.

\begin{mainlemma}
\label{lem:cnf}
  If $Γ ⊢ φ$ then $Γ ⊢ \rm{cnf}~φ$, where,
  \begin{align*}
    \begin{split}
    &\rm{cnf} : \Prop \to \Prop\\
    &\rm{cnf}~φ = \fform (\fdist (\fnnf~φ))
    \end{split}
  \end{align*}
\end{mainlemma}

\begin{proof}
  Composition of Lemma~\ref{lem:lem-form} and Lemma~\ref{lem:lem-dist}
  and \ref{lem:lem-nnf}.
\end{proof}

Since all the previous transformations came from  equivalences in  the
classical propositional logic, the following theorem plays an important role
in the next section.

\begin{mainth}
\label{thm:invCnfThm}
  If $Γ ⊢ \rm{cnf}~φ$ then $Γ ⊢ φ$.
\end{mainth}

The \canonicalize rule is an overloaded inference rule which performs
normalization of the proposition input.
This rule converts a \texttt{fof} %TODO
formula in clausal form to a \CNF clause but also it performs some
simplifications in the process (e.g., removing ⊤ and ⊥ in the formula).

Since this rule mostly consists of dealing with \CNF clauses, to
justify its reasoning, our strategy mainly consists of checking the
equality of normalized negative form between the source and the
target formula. If it fails, we try to reorder the conjunctive
normal form of the source formula to match with
the conjunctive normal form of the target formula.

\begin{mainth} % (fold)
  \label{thm:canonicalize}
  If $Γ ⊢ φ$ and $ψ : \Prop$ then $Γ~⊢~\fcanonicalize~φ~ψ$, where,
  \begin{equation}
  \label{eq:canonicalize}
  \begin{aligned}
  &\hspace{.495mm}\fcanonicalize : \Prop \to \Prop \to \Prop\\
  &\fcanonicalize~φ~ψ = \begin{cases}
        ψ, &\text{ if  } ψ≡φ\\
        ψ, &\text{ if  } ψ≡\fform(\fnnf~φ)\\
        ψ, &\text{ if  } \fcnf~ψ≡ \freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ)\\
        φ, &\text{ otherwise }
        \end{cases}
   \end{aligned}
  \end{equation}
\end{mainth}

\begin{proof}\hspace{3mm}
\begin{itemize}
\item[$\bullet$] If $φ ≡ ψ$ by substitution theorem we conclude $Γ ⊢ ψ$.
\item[$\bullet$] If $ψ ≡ \fform~(\fnnf~φ)$,
\begin{equation*}
  \begin{bprooftree}
    \AxiomC{$Γ ⊢ φ$}
    \RightLabel{lem-nnf}
    \UnaryInfC{$Γ ⊢₂~\fnnf~φ$}
    \RightLabel{lem-form}
    \UnaryInfC{$Γ ⊢ \fform~(\fnnf~φ)$}
    \AxiomC{$ψ ≡ \fform~(\fnnf~φ)$}
    \RightLabel{subst.}
    \BinaryInfC{$Γ ⊢ ψ$}
  \end{bprooftree}
\end{equation*}

\item[$\bullet$] If $γ ≡ \fcnf~ψ ≡ \freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ)$,
  \begin{equation*}
    \begin{bprooftree}
      \AxiomC{$Γ ⊢ φ$}
      \RightLabel{thm-cnf}
      \UnaryInfC{$Γ ⊢ \fcnf~φ$}
      \RightLabel{thm-reorder$_{∧∨}$}
      \UnaryInfC{$Γ ⊢ \freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ)$}
      \AxiomC{$γ$}
      \RightLabel{subst}
      \BinaryInfC{$Γ ⊢ \fcnf~ψ$}
      \RightLabel{thm-inv-cnf.}
      \UnaryInfC{$Γ ⊢ ψ$}
    \end{bprooftree}
  \end{equation*}
\end{itemize}
\end{proof}

\end{document}
