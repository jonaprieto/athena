\documentclass[../../main.tex]{subfiles}
\begin{document}


\subsubsection{Canonicalize.}
\label{sssec:canonicalize}

The \canonicalize rule is an inference that transforms a formula to a its
negative normal form or its conjunctive normal form depending on
the role that the formula plays in the problem as we explain in a moment.
However, in both cases, this rule removes inside the formula as long as it
possible any redundancy (\ie, tautologies or definitions).

\begin{mydefinition}
The \emph{negative normal form} of a formula is the logical equivalent version of it
in which negations appear only in the literals and the formula does not
contain any implications.

\end{mydefinition}

\begin{mydefinition}

The \emph{conjunctive normal form} of a formula also called clausal normal form
is the logical equivalent version expressed as a conjunction of clauses, where
a \emph{clause} is the disjunction of zero or more literals.

\end{mydefinition}

This rule is used by \Metis to introduce the subgoals in their refutation proofs
but also helps to simplify formulas in intermediate steps in the derivation. As
far as we know, the \canonicalize rule in these cases uses the conjunctive
normal form with simplifications. Otherwise, when an axiom, definition or
hypothesis is needed to prove some goal, this rule is used with the negative
normal form of the formula.

The \canonicalize rule jointly with the \clausify rule perform the so-called
\emph{clausification} mainly described by
\citeauthor{Sutcliffe1996}~\cite{Sutcliffe1996}.

To reconstruct the \canonicalize rule, we adapted some ideas from the \Metis
source code. The presentation of this reconstruction is as follows. We firstly
describe functions to remove redundancies inside the formula. After, we present
the negative normal form conversion in~Lemma~\ref{lem:nnf} and the conjunctive
normal form in Lemma~\ref{lem:cnf}. At the end of this section, we state
Theorem~\ref{thm:canonicalize} to reconstruct the \canonicalize rule.

Now, we say that there are redundancies in a formula when some of the theorems
in~Fig.~\ref{fig:redundancies} can be applied inside of it.

\begin{figure}
  \[
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ ⊥$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ ⊤$}
      \UnaryInfC{$Γ ⟝ ⊤$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ ¬ φ$}
      \UnaryInfC{$Γ ⟝ ⊤$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∨ φ$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
  \]

  \[
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ ⊥$}
      \UnaryInfC{$Γ ⟝ ⊥$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ ⊤$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ φ$}
      \UnaryInfC{$Γ ⟝ φ$}
    \end{bprooftree}
    \qquad
    \begin{bprooftree}
      \AxiomC{$Γ ⟝ φ ∧ ¬ φ$}
      \UnaryInfC{$Γ ⟝ ⊥$}
    \end{bprooftree}
  \]
  \caption{Theorems to remove redundancies inside of a formula.}
\label{fig:redundancies}
\end{figure}


\begin{notation}
In a disjunction, $φ ≡ φ₁ ∨ φ₂ ∨ \cdots ∨ φₙ$, we say $ψ ∈_{∨} φ$,
if there is some $i = 1, \cdots, n$ such that $ψ ≡ φᵢ$.
Note that $ψ ∈_{∨} φ$ is another name for the equality
$ψ ≡ \fconjunctor~φ~ψ$.
\end{notation}

Lemma~\ref{lem:canon-or} serves to remove redundancies in the disjunctions.
We assume the formulas to be right-associative unless otherwise stated.



The other redundancies in Fig.~\ref{fig:or-redundancies} are removed by
applying Lemma~\ref{lem:canon-or}.
This lemma incorporates the $\frm_{∨}$ function.

\begin{figure}
\begin{equation*}
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ ⊥$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ ⊤$}
  \UnaryInfC{$Γ ⟝ ⊤$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ φ$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ ¬~φ$}
  \UnaryInfC{$Γ ⟝ ⊤$}
\end{bprooftree}\qquad
\end{equation*}
\caption{Theorems to remove redundancies inside of a disjunction.}
\label{fig:or-redundancies}
\end{figure}

\begin{mainlemma}
  \label{lem:canon-or}

  If $Γ ⟝ φ$ and let $φ : \Prop$ be a right-associative formula in negative
  normal form then $Γ ⟝ \fcanon_{∨}~φ$ where,

\begin{equation*}
\label{eq:canon-or}
\begin{aligned}
 &\hspace{.495mm}\fcanon_{∨} : \NProp \to \NProp\\
 &\begin{array}{lll}
   \fcanon_{∨} &(φ ∨ ⊥)     &= \fcanon_{∨}~φ \\
   \fcanon_{∨} &(⊥ ∨ φ)     &= \fcanon_{∨}~φ \\
   \fcanon_{∨} &(⊤ ∨ φ)     &= ⊤  \\
   \fcanon_{∨} &(φ ∨ ⊤)     &= ⊤  \\
   % \fcanon_{∨} &(¬ φ₁ ∨ φ₂) &=
   %      \begin{cases}
   %       \fcanon_{∨}~φ₂,        &\text{ if } ¬ φ₁ ∈_{∨} φ₂;\\
   %       ⊤,                     &\text{ if } φ₁ ∈_{∨} φ₂;\\
   %       ⊤,                     &\text{ if } \fcanon_{∨}~φ₂≡ ⊤;\\
   %       ¬ φ₁,                  &\text{ if } \fcanon_{∨}~φ₂≡ ⊥;\\
   %       ¬ φ₁ ∨ \fcanon_{∨}~φ₂, &\text{ otherwise.}
   %      \end{cases}\\
   \fcanon_{∨} &(φ₁ ∨ φ₂)   &=
        \begin{cases}
         ⊤,                     & \text{ if } φ₁ ≡ ¬ ψ \text{ for some }ψ : \Prop \text{ and } ψ ∈_{∨} φ₂;\\
         ⊤,                     & \text{ if } (¬ φ₁) ∈_{∨} φ₂;\\
         \fcanon_{∨}~φ₂,        & \text{ if } φ₁ ∈_{∨} φ₂;\\
         ⊤,                     & \text{ if } \fcanon_{∨}~φ₂~ ≡ ⊤;\\
         ¬ φ₁,                  & \text{ if } \fcanon_{∨}~φ₂~ ≡ ⊥;\\
         φ₁ ∨ \fcanon_{∨}~φ₂,   & \text{ otherwise.}
        \end{cases}\\
   \fcanon_{∨} &φ         &= φ.
  \end{array}
\end{aligned}
\end{equation*}
\end{mainlemma}

\begin{myexample}

The formula $φ ∨ (ψ ∨ (φ ∨ φ)) ∨ φ$ in \eqref{eq:lemma-rm-or-example} has
redundancies. To remove such redundancies we first use Lemma~\ref{lem:rassoc}
to get the right-associative version of the formula. Then, we can use the
$\fcanon_{∨}$ function to get the logical equivalent formula $ψ ∨ φ$.

\begin{equation}
\label{eq:lemma-rm-or-example}
  \begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∨ (ψ ∨ (φ ∨ φ)) ∨ φ $}
  \RightLabel{Lemma~\ref{lem:rassoc}}
  \UnaryInfC{$Γ ⟝ \fassoc_{∨}~(φ ∨ (ψ ∨ (φ ∨ φ)) ∨ φ) $}
  \RightLabel{by (\ref{eq:fassoc})}
  \UnaryInfC{$Γ ⟝ φ ∨ (ψ ∨ (φ ∨ (φ ∨ φ)))$}
  \RightLabel{Lemma~\ref{lem:canon-or}}
  \UnaryInfC{$Γ ⟝ \fcanon_{∨}~(φ ∨ (ψ ∨ (φ ∨ (φ ∨ φ))))$}
  \RightLabel{\eqref{eq:canon-or}}
  \UnaryInfC{$Γ ⟝ ψ ∨ φ$}
  \end{bprooftree}
  \end{equation}
\end{myexample}

Now, we have removed redundancies in the disjunctions by applying the
$\fcanon_{∨}$ function. In a similar way, we define the $\fcanon_{∧}$ function
to work with conjunctions.

\begin{notation}
In a conjunction, $φ ≡ φ₁ ∧ φ₂ ∧ \cdots ∧ φₙ$, we say
$ψ ∈_{∧} φ$, if there is some $i = 1, \cdots, n$ such that $ψ ≡ φᵢ$.
Note that $ψ ∈_{∧} φ$ as the equality $ψ ≡ \fconjunct~φ~ψ$.
\end{notation}

In right-associative conjunctions we remove the redundancies
in \ref{fig:and-redundancies} using Lemma~\ref{lem:canon-and}.

\begin{figure}
\begin{equation*}
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ ¬~φ$}
  \UnaryInfC{$Γ ⟝ ⊥$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ ⊤$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ ⊥$}
  \UnaryInfC{$Γ ⟝ ⊥$}
\end{bprooftree}\qquad
\begin{bprooftree}
  \AxiomC{$Γ ⟝ φ ∧ φ$}
  \UnaryInfC{$Γ ⟝ φ$}
\end{bprooftree}
\end{equation*}
\caption{Theorems to remove redundancies inside of a conjunction.}
\label{fig:and-redundancies}
\end{figure}

\begin{mainlemma}
  \label{lem:canon-and}
  If $Γ ⟝ φ$ and let $φ : \Prop$ be a right-associative formula in
  negative normal form
   then $Γ ⟝ \fcanon_{∧}~φ$ where,
  \begin{equation*}
   \label{eq:canon-and}
    \begin{aligned}
     &\hspace{.495mm}\fcanon_{∧} : \NProp \to \NProp\\
      &\begin{array}{lll}
        \fcanon_{∧} &(⊤ ∧ φ)     &= \fcanon_{∧}~φ \\
        \fcanon_{∧} &(φ ∧ ⊤)     &= \fcanon_{∧}~φ \\
        \fcanon_{∧} &(⊥ ∧ φ)     &= ⊥  \\
        \fcanon_{∧} &(φ ∧ ⊥)     &= ⊥  \\
        % \fcanon_{∧} &(¬ φ₁ ∧ φ₂) &=
        %   \begin{cases}
        %     ⊥,                     &\text{ if } φ₁ ∈_{∧} φ₂;\\
        %     \fcanon_{∧}~φ₂,        &\text{ if } ¬ φ₁ ∈_{∧} φ₂;\\
        %     ⊥,                     &\text{ if } \fcanon_{∧}~φ₂~≡ ⊥;\\
        %      \fcanon_{∧}~φ₂,       &\text{ if } \fcanon_{∧}~φ₂~≡ ⊤;\\
        %     ¬ φ₁ ∧ \fcanon_{∧}~φ₂, &\text{ otherwise.}
        %   \end{cases}\\
        \fcanon_{∧} &(φ₁ ∧ φ₂) &=
          \begin{cases}
            ⊥,                   & \text{ if } φ₁ ≡ ¬ ψ \text{ for some }ψ : \Prop \text{ and } ψ ∈_{∧} φ₂;\\
            ⊥,                   & \text{ if } ¬ φ₁ ∈_{∧} φ₂;\\
            \fcanon_{∧}~φ₂,      & \text{ if } φ₁ ∈_{∧} φ₂;\\
            ⊥,                   & \text{ if } \fcanon_{∧}~φ₂~≡ ⊥;\\
            φ₁ ∧ \fcanon_{∧}~φ₂, &\text{ otherwise.}
          \end{cases}\\
        \fcanon_{∧} &φ         &= φ.
       \end{array}
    \end{aligned}
    \end{equation*}
\end{mainlemma}

Now, we are ready to define the negative normal form of a formula after
simplifications by applying to it the $\fnnfp$ function defined and after
simplifications functions (\ie, $\fcanon_{∨}$ and $\fcanon_{∧}$).
in~\eqref{eq:nnf-zero}. Its definition is mainly based on the \Metis source code to
normalize formulas. To define such a function in type theory we follow the same
approach described in \citeauthor{Bezem2002}~\cite{Bezem2002}. The authors avoid
a termination problem with a similar function by using the polarity of the
formula as an additional argument of the function.

\begin{equation}
\label{eq:nnf-zero}
  \begin{aligned}
  &\hspace{.495mm}\fnnfp : \abbre{Polarity} \to \Prop \to \NProp\\
    &\begin{array}{lll}
      \fnnfp~⊕~(φ₁ ∧ φ₂) &=\fcanon_{∧}~(\fnnfp~⊕~φ₁ ∧ \fnnfp~⊕~φ₂)\\
      \fnnfp~⊕~(φ₁ ∨ φ₂) &=\fcanon_{∨}~(\fnnfp~⊕~φ₁ ∨ \fnnfp~⊕~φ₂)\\
      \fnnfp~⊕~(φ₁ ⇒ φ₂) &=\fcanon_{∨}~(\fnnfp~⊖~φ₁ ∨ \fnnfp~⊕~φ₂)\\
      \fnnfp~⊕~(¬ φ₁)    &=\fnnfp~⊖~φ₁                              \\
      \fnnfp~⊕~φ         &=φ        \\
      \fnnfp~⊖~(φ₁ ∧ φ₂) &=\fcanon_{∨}~(\fnnfp~⊖~φ₁ ∨ \fnnfp~⊖~φ₂)\\
      \fnnfp~⊖~(φ₁ ∨ φ₂) &=\fcanon_{∧}~(\fnnfp~⊖~φ₁ ∧ \fnnfp~⊖~φ₂)\\
      \fnnfp~⊖~(φ₁ ⇒ φ₂) &=\fcanon_{∧}~(\fnnfp~⊖~φ₂ ∧ \fnnfp~⊖~φ₁)\\
      \fnnfp~⊖~(¬ φ₁)    &=\fnnfp~⊕~φ₁\\
      \fnnfp~⊖~⊤         &=⊥\\
      \fnnfp~⊖~⊥         &=⊤\\
      \fnnfp~⊖~φ         &=φ.
    \end{array}
  \end{aligned}
\end{equation}

We define the \abbre{Polarity} type which has
two constructors: $⊕$ to denote positive polarity, and $⊖$ to denote
negative polarity of a formula.

% \begin{myremark}
% The formula polarity was not
% relevant in the following description since we found using the $⊕$ polarity to
% call \fpolarity function for the first time was enough to get
% the normalized normal form for propositions.
% \end{myremark}

\begin{mainlemma}
  \label{lem:nnf}
  If $Γ ⊢ φ$ then $Γ ⟝ \fnnf~φ$ where,
  \begin{align*}
   \begin{split}
     &\fnnf : \NProp \to \NProp\\
     &\fnnf~φ = \fnnfp~⊕~φ.
   \end{split}
  \end{align*}
\end{mainlemma}

Now, to convert a formula to its conjunctive normal form, in
Lemma~\ref{lem:dist} we apply the appropriate distribution functions to the
normalized negative formula given by the $\fnnf$ function.

\begin{mainlemma}
  \label{lem:dist}
  $Γ ⟝ φ$ then $Γ ⟝ \fdist~φ$ where,
  \begin{equation*}
  \begin{aligned}
  &\hspace{.495mm}\fdist : \NProp \to \NProp\\
  &\begin{array}{lll}
    \fdist &(φ₁ ∧ φ₂) &= \fdist~φ₁ ∧ \fdist~φ₂\\
    \fdist &(φ₁ ∨ φ₂) &= \fdist_{∨}~(\fdist~φ₁ ∨ \fdist~φ₂)\\
    \fdist &φ         &= φ
   \end{array}\\
  \text{and}\\
  &\hspace{.495mm}\fdist_{∨} : \NProp \to \NProp\\
  &\begin{array}{lll}
    \fdist_{∨}&((φ₁ ∧ φ₂) ∨ φ₃) &= \fdist_{∨}~(φ₁ ∨ φ₂) ∧ \fdist_{∨}~(φ₂ ∨ φ₃)\\
    \fdist_{∨}&(φ₁ ∨ (φ₂ ∧ φ₃)) &= \fdist_{∨}~(φ₁ ∨ φ₂) ∧ \fdist_{∨}~(φ₁ ∨ φ₃)\\
    \fdist_{∨}&φ &= φ.
    \end{array}
   \end{aligned}
  \end{equation*}
\end{mainlemma}

We get the conjunctive normal form by applying
the $\fnnf$ function follow by the $\fdist$ function.

\begin{mainlemma}
\label{lem:cnf}
  If $Γ ⊢ φ$ then $Γ ⊢ \fcnf~φ$ where,
  \begin{align*}
    \begin{split}
    &\fcnf : \Prop \to \Prop\\
    &\fcnf~φ = \fdist~(\fnnf~φ).
    \end{split}
  \end{align*}
\end{mainlemma}

\begin{proof}
  Composition of Lemma~\ref{lem:dist} and Lemma~\ref{lem:nnf}.
  and \ref{lem:nnf}.
\end{proof}

Since all the transformations in Lemma~\ref{lem:nnf} and Lemma~\ref{lem:dist}
came from logical equivalences in propositional logic, we state the following lemma to reconstruct the \canonicalize rule in Theorem~\ref{thm:canonicalize}.

\begin{mainlemma}
\label{lem:cnf-inv}
  If $Γ ⊢ \fcnf~φ$ then $Γ ⊢ φ$.
\end{mainlemma}

The \fcanonicalize rule is a inference rule defined in \eqref{eq:canonicalize}
which performs normalization for a proposition. That is, depending on the role
of the formula in the problem, it converts the formula to its negated normal
form or its conjunctive normal form but in both cases, \canonicalize simplifies
the formula by removing redundancies inside it as we widely described above
Fig.~\ref{fig:redundancies}. When the formula plays the axiom or definition
role, the \canonicalize rule transforms the source formula to its negated
normal form. Otherwise, this rule converts the formula to its conjunctive
normal form.

Since this rule mostly consists of dealing with clauses, to to reconstruct this
rule, our strategy mainly consists of checking the equality of normalized
negative form between the source and the target formula. If it fails, we try to
reorder the conjunctive normal form of the source formula to match with the
conjunctive normal form of the target formula.


\begin{mainth} % (fold)
  \label{thm:canonicalize}
  If $Γ ⊢ φ$ and $ψ : \Target$ then $Γ~⊢~\fcanonicalize~φ~ψ$ where,
  \begin{equation}
  \label{eq:canonicalize}
  \begin{aligned}
  &\hspace{.495mm}\fcanonicalize : \Source \to \Target \to \Prop\\
  &\fcanonicalize~φ~ψ = \begin{cases}
        ψ, &\text{ if  } ψ≡φ;\\
        ψ, &\text{ if  } \fcnf~ψ≡ \freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ);\\
        φ, &\text{ otherwise. }
        \end{cases}
   \end{aligned}
  \end{equation}
\end{mainth}

\begin{proof}\hspace{3mm}
\begin{itemize}
\item[∙] Case $φ ≡ ψ$. By substitution theorem we conclude $Γ ⊢ ψ$.
\item[∙] Case $ψ ≡ \fnnf~φ$.
\begin{equation*}
  \begin{bprooftree}
    \AxiomC{$Γ ⊢ φ$}
    \RightLabel{Lemma~\ref{lem:nnf}}
    \UnaryInfC{$Γ ⊢₂~\fnnf~φ$}
    \AxiomC{$ψ ≡ \fnnf~φ$}
    \RightLabel{\fsubst}
    \BinaryInfC{$Γ ⊢ ψ$}
  \end{bprooftree}
\end{equation*}

\item[∙] Case $\fcnf~ψ ≡ \freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ)$.
  \begin{equation*}
    \begin{bprooftree}
      \AxiomC{$Γ ⊢ φ$}
      \RightLabel{Lemma~\ref{lem:cnf}}
      \UnaryInfC{$Γ ⊢ \fcnf~φ$}
      \RightLabel{Lemma~\ref{lem:reorder-and-or}}
      \UnaryInfC{$Γ ⊢ \freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ)$}
      \AxiomC{$\fcnf~\freorder_{∧∨}~(\fcnf~φ)~(\fcnf~ψ)$}
      \RightLabel{\fsubst}
      \BinaryInfC{$Γ ⊢ \fcnf~ψ$}
      \RightLabel{Lemma~\ref{lem:cnf-inv}}
      \UnaryInfC{$Γ ⊢ ψ$}
    \end{bprooftree}
  \end{equation*}
\end{itemize}
\end{proof}

\end{document}
